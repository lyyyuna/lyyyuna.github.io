
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>lyyyuna 的小花园: SCons 用户指南第四章 - 编译和链接库</title>
    
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  table {
      border-collapse: collapse;
      width: 100%;
  }
  th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
  }
  th {
      background-color: #f2f2f2;
  }
  
  .icp {
    margin: 10px 0;
    width: 100%;
    height: 36px;
    white-space: pre;
    text-align: center;
    color: gray;
    z-index: 1000;
  }
  body {
    padding: 0;
    margin: 0;
    font-size: 112.5%;
    font-family: serif;
  }
  @media print {
    img {page-break-inside: avoid;}
    div.nosplit {page-break-inside: avoid;}
  }
  img {
    width: 100%;
  }
  img.center {
    display: block;
    margin: 0 auto;
  }
  img.resizable {
    max-width: 100%;
    height: auto;
  }
  p code, li code {
    font-size: 14px;
    word-wrap: break-word;
    padding: 2px 4px;
    border-radius: 4px;
    margin: 0 2px;
    color: #1e6bb8;
    background-color: rgba(27,31,35,.05);
    font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;
    word-break: break-all;
  }
  strong {
    font-weight: bold;
    color: darkred;
  }
  .pad {
    padding-top: 1em;
    padding-bottom: 1em;
  }
  a.anchor, a.back, a.footnote {
    color: black !important;
    text-decoration: none !important;
  }
  a.back {
    font-size: 50%;
  }
  @media print {
    a.back {display: none;}
  }
  .header {
    height: 1.25em;
    background-color: #dff;
    margin: 0;
    padding: 0.1em 0.1em 0.2em;
    border-top: 1px solid black;
    border-bottom: 1px solid #8ff;
  }
  .header h3 {
    margin: 0;
    padding: 0 2em;
    display: inline-block;
    padding-right: 2em;
    font-style: italic;
    font-size: 90%;
  }
  .rss {
    float: right;
    padding-top: 0.2em;
    padding-right: 2em;
    display: none;
  }
  .toc {
    margin-top: 2em;
  }
  .toc-title {
    font-family: cursive, serif;
    font-style: italic;
    font-size: 300%;
    line-height: 83%;
  }
  .toc-subtitle {
    display: block;
    margin-bottom: 1em;
    font-size: 83%;
  }
  @media only screen and (max-width: 550px) { .toc-subtitle { display: none; } }
  .header h3 a {
    color: black;
  }
  .header h4 {
    margin: 0;
    padding: 0;
    display: inline-block;
    font-weight: normal;
    font-size: 83%;
  }
  @media only screen and (max-width: 550px) { .header h4 { display: none; } }
  .main {
    padding: 0 2em;
  }
  @media only screen and (max-width: 479px) { .article { font-size: 120%; } }
  .article h1 {
    text-align: center;
    font-size: 200%;
  }
  .copyright {
    font-size: 83%;
  }
  .subtitle {
      font-size: 65%;
  }
  .normal {
    text-align: center;
    font-size: medium;
    font-weight: normal;
  }
  .when {
    text-align: center;
    font-size: 100%;
    margin: 0;
    padding: 0;
  }
  .when p {
    margin: 0;
    padding: 0;
  }
  .article h2 {
    font-size: 125%;
    padding-top: 0.25em;
  }
  .article h3 {
    font-size: 100%;
  }
  .footer {
    margin-top: 10px;
    font-size: 83%;
    font-family: sans-serif;
  }
  .comments {
    margin-top: 2em;
    background-color: #ffe;
    border-top: 1px solid #aa4;
    border-left: 1px solid #aa4;
    border-right: 1px solid #aa4;
  }
  .comments-header {
    padding: 0 5px 0 5px;
  }
  .comments-header p {
    padding: 0;
    margin: 3px 0 0 0;
  }
  .comments-body {
    padding: 5px 5px 5px 5px;
  }
  #plus-comments {
    border-bottom: 1px dotted #ccc;
  }
  .plus-comment {
    width: 100%;
    font-size: 14px;
    border-top: 1px dotted #ccc;
  }
  .me {
    background-color: #eec;
  }
  .plus-comment ul {
    margin: 0;
    padding: 0;
    list-style: none;
    width: 100%;
    display: inline-block;
  }
  .comment-when {
    color:#999;
    width:auto;
    padding:0 5px;
  }
  .old {
    font-size: 83%;
  }
  .plus-comment ul li {
    display: inline-block;
    vertical-align: top;
    margin-top: 5px;
    margin-bottom: 5px;
    padding: 0;
  }
  .plus-icon {
    width: 45px;
  }
  .plus-img {
    float: left;
    margin: 4px 4px 4px 4px;
    width: 32px;
    height: 32px;
  }
  .plus-comment p {
    margin: 0;
    padding: 0;
  }
  .plus-clear {
    clear: left;
  }
  .toc-when {
    font-size: 83%;
    color: #999;
  }
  .toc {
    list-style: none;
  }
  .toc li {
    margin-bottom: 0.5em;
  }
  .toc-head {
    margin-bottom: 1em !important;
    font-size: 117%;
  }
  .toc-summary {
    margin-left: 2em;
  }
  .favorite {
    font-weight: bold;
  }
  .article p, .article ol {
    line-height: 144%;
  }
  sup, sub {
    vertical-align: baseline;
    position: relative;
    font-size: 83%;
  }
  sup {
    bottom: 1ex;
  }
  sub {
    top: 0.8ex;
  }

  .main {
    position: relative;
    margin: 0 auto;
    padding: 0;
    width: 900px;
  }
  @media only screen and (min-width: 768px) and (max-width: 959px) { .main { width: 708px; } }
  @media only screen and (min-width: 640px) and (max-width: 767px) { .main { width: 580px; } }
  @media only screen and (min-width: 480px) and (max-width: 639px) { .main { width: 420px; } }
  @media only screen and (max-width: 479px) { .main { width: 90%; } }

  .pager {display: flex;margin-bottom: 20px}
  .pager:last-of-type {margin-top: 50px;}

  .pager span, .pager   a {flex: 50%;line-height:50px;}
  .pager a {color: var(--pager-fg); padding: 0 10px; border-radius: 4px; border: 1px solid #ccc; text-decoration: none; }
  .pager a:hover{background: var(--pager-hover); border-color: #bbb;}
  .pager .prev {margin-right: 10px;}
  .pager a.prev:not(:empty):before{content: '« '}
  .pager a.next:not(:empty):after{content: ' »'}
  .pager .next {text-align: right;margin-left: 10px}

</style>
<link rel="stylesheet" href="/libs/highlight/styles/a11y-dark.min.css">
<script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body>
    
<div class="header">
  <h3><a href="/">lyyyuna 的小花园</a></h3>
  <h4>动静中之动,
    by <a href="https://www.lyyyuna.com/about/" rel="author">lyyyuna</a> </h4>
  <a class="rss" href="https://www.lyyyuna.com/feed.atom">RSS</a>
</div>

<div class="main">
  <div class="article">
    <h1>SCons 用户指南第四章 - 编译和链接库
    
    <div class="subtitle">(<i><a href="/series/SCons 用户指南/">SCons 用户指南</a>, Part 4</i>)</div>
    </h1>
    <div class="normal">
      <div class="when">
        
          发表于 2015-12
          
      </div>
    </div>
    <p>在大型软件工程中，经常将部分软件合并成一个或多个库文件。SCons 在创建和使用库文件方面非常简单易用。</p>
<h2>4.1 编译库</h2>
<p>你可以代替 Program 使用 Library 来生成你自己的库文件：</p>
<pre><code>Library('foo', ['f1.c', 'f2.c', 'f3.c'])
</code></pre>
<p>SCons 会自动根据你的系统使用合适的库文件前缀和后缀。所以在 POSIX 或 Linux 系统上，上面的例子编译过程如下：</p>
<pre><code>% scons -Q
cc -o f1.o -c f1.c
cc -o f2.o -c f2.c
cc -o f3.o -c f3.c
ar rc libfoo.a f1.o f2.o f3.o
ranlib libfoo.a
</code></pre>
<p>在 Windows 系统上，上述例子的编译过程如下：</p>
<pre><code>C:\&gt;scons -Q
cl /Fof1.obj /c f1.c /nologo
cl /Fof2.obj /c f2.c /nologo
cl /Fof3.obj /c f3.c /nologo
lib /nologo /OUT:foo.lib f1.obj f2.obj f3.obj
</code></pre>
<p>目标库文件的命名规则类似于直接生成程序：如果你没有显示指定目标库文件名称，SCons 会从第一个指定的源文件名字中推导出，并且 SCons 会加上合适的文件前缀和后缀。</p>
<h3>4.1.1 从源码或二进制文件编译库</h3>
<p>上一个例子战士了如何从一系列源码中编译出库文件，然而你也可以在 Library 调用中放置二进制文件，它会自动分析出这些是二进制文件。事实上，你也可以在源队列中混合使用源代码文件和二进制文件：</p>
<pre><code>Library('foo', ['f1.c', 'f2.o', 'f3.c', 'f4.o'])
</code></pre>
<p>SCons 能够意识到在生成最终库文件前需要编译哪些源文件：</p>
<pre><code>% scons -Q
cc -o f1.o -c f1.c
cc -o f3.o -c f3.c
ar rc libfoo.a f1.o f2.o f3.o f4.o
ranlib libfoo.a
</code></pre>
<p>当然，在这个例子中，必须先编译出这些二进制文件。请查看第五章，如何显示编译自己的二进制文件并包含在自己的库文件中。</p>
<h3>4.1.2 编译静态库：使用 StaticLibrary 方法</h3>
<p>Library 方法能够编译一个传统的静态库文件。如果你想明确地控制库文件的类型，你可以使用 StaticLibrary 方法来代替 Library：</p>
<pre><code>StaticLibrary('foo', ['f1.c', 'f2.c', 'f3.c'])
</code></pre>
<p>在功能上它们之间没有区别。</p>
<h3>4.1.3 编译动态库（DLL）：使用 SharedLibrary 方法</h3>
<p>如果你像编译在 POSIX 系统或者 Windows 系统上编译动态库文件，你应该使用 SharedLibrary 方法：</p>
<pre><code>SharedLibrary('foo', ['f1.c', 'f2.c', 'f3.c'])
</code></pre>
<p>在 POSIX 系统上输出为：</p>
<pre><code>% scons -Q
cc -o f1.os -c f1.c
cc -o f2.os -c f2.c
cc -o f3.os -c f3.c
cc -o libfoo.so -shared f1.os f2.os f3.os
</code></pre>
<p>在 Windows 系统上输出为：</p>
<pre><code>C:\&gt;scons -Q
cl /Fof1.obj /c f1.c /nologo
cl /Fof2.obj /c f2.c /nologo
cl /Fof3.obj /c f3.c /nologo
link /nologo /dll /out:foo.dll /implib:foo.lib f1.obj f2.obj f3.obj
RegServerFunc(target, source, env)
embedManifestDllCheck(target, source, env)
</code></pre>
<p>你可以注意到 SCons 能够正确处理输出文件的过程，在 POSIX 系统上假设 -shared 选项，在 Windows 系统上加上 /dll 选项。</p>
<h2>4.2 链接库</h2>
<p>通常，你之所以编译库文件是为了在多个程序中链接它。为了链接库，你只需要在 $LIBS 构造变量中指定库，在 $LIBPATH 构造变量中指定库文件所在的目录：</p>
<pre><code>Library('foo', ['f1.c', 'f2.c', 'f3.c'])
Program('prog.c', LIBS=['foo', 'bar'], LIBPATH='.')
</code></pre>
<p>很显然可以注意到，你不需要指定库的前缀（比如 lib）或者后缀（比如 .a 或 .lib）。SCons 能够为当前的系统使用正确的前缀和后缀。</p>
<p>在类 POSIX 系统中，以上例子的编译过程为：</p>
<pre><code>% scons -Q
cc -o f1.o -c f1.c
cc -o f2.o -c f2.c
cc -o f3.o -c f3.c
ar rc libfoo.a f1.o f2.o f3.o
ranlib libfoo.a
cc -o prog.o -c prog.c
cc -o prog prog.o -L. -lfoo -lbar
</code></pre>
<p>在 Windows 系统上，以上例子的编译过程为：</p>
<pre><code>C:\&gt;scons -Q
cl /Fof1.obj /c f1.c /nologo
cl /Fof2.obj /c f2.c /nologo
cl /Fof3.obj /c f3.c /nologo
lib /nologo /OUT:foo.lib f1.obj f2.obj f3.obj
cl /Foprog.obj /c prog.c /nologo
link /nologo /OUT:prog.exe /LIBPATH:. foo.lib bar.lib prog.obj
embedManifestExeCheck(target, source, env)
</code></pre>
<p>像之前一样，可以注意到 SCons 能够正确地构造命令行，以确保在各个系统上能够链接正确的库。</p>
<p>并且，如果你只有一个库需要链接，你可以用单个字符串，来代替 Python 的列表，即：</p>
<pre><code>Program('prog.c', LIBS='foo', LIBPATH='.')
</code></pre>
<p>这和以下是等价的：</p>
<pre><code>Program('prog.c', LIBS=['foo'], LIBPATH='.')
</code></pre>
<p>这和 SCons 在处理单个源文件中既可以使用字符串或者列表，是类似的。</p>
<h2>4.3 寻找库：$LIBPATH 构造变量</h2>
<p>链接器默认只在系统指定的路径中寻找库文件。当你指定了 $LIBPATH 构造变量，SCons 知道如何寻找库文件。$LIBPATH 由一系列目录路径构成，如下：</p>
<pre><code>Program('prog.c', LIBS = 'm', LIBPATH = ['/usr/lib', '/usr/local/lib'])
</code></pre>
<p>推荐使用 Python 列表，因为这具有可移植性。你也可以将所有目录名字放在一个字符串中。在 POSIX 系统中，使用冒号来分割目录路径：</p>
<pre><code>LIBPATH = '/usr/lib:/usr/local/lib'
</code></pre>
<p>或者在 Windows 系统上使用分号来分割：</p>
<pre><code>LIBPATH = 'C:\\lib;D:\\lib'
</code></pre>
<p>（注意到，在 Windows 系统上必须对反斜杠进行转义。）</p>
<p>当链接器执行时，SCons 会生成合适的标志位，这样链接器就将去寻找 SCons 指定的路径。所以在 POSIX 系统上，上述例子的编译过程如下：</p>
<pre><code>% scons -Q
cc -o prog.o -c prog.c
cc -o prog prog.o -L/usr/lib -L/usr/local/lib -lm
</code></pre>
<p>或者在 Windows 系统上，上述例子的编译过程如下：</p>
<pre><code>C:\&gt;scons -Q
cl /Foprog.obj /c prog.c /nologo
link /nologo /OUT:prog.exe /LIBPATH:\usr\lib /LIBPATH:\usr\local\lib m.lib prog.obj
embedManifestExeCheck(target, source, env)
</code></pre>
<p>注意到 SCons 能够正确地根据系统生成合适的命令行参数。</p>

  </div>

    
    <div class="pager">

      
        <a class="prev" href="/2015/12/03/scons3-less-simple-things-to-do-with-builds/">
          SCons 用户指南第三章-让 SCons 编译更简单
        </a>
      

      
        <a class="next" href="/2016/01/03/scons5-node-objects/">
          SCons 用户指南第五章 - 节点对象
        </a>
      

    </div>
    
  <div class="icp"> lyyyuna <a href="https://beian.miit.gov.cn/" target="_blank" rel="nofollow">沪ICP备2025110782号-1</a></div>
</div>



<div id="stats" class="icp"></div> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-1G7RNXMWQX"></script> <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1G7RNXMWQX');
</script> <script async src="https://analytics.lyyyuna.com/v1/stats.js"></script>


</body>
</html>
