
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>lyyyuna 的小花园: SCons 用户指南第三章-让 SCons 编译更简单</title>
    
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  table {
      border-collapse: collapse;
      width: 100%;
  }
  th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
  }
  th {
      background-color: #f2f2f2;
  }
  
  .icp {
    margin: 10px 0;
    width: 100%;
    height: 36px;
    white-space: pre;
    text-align: center;
    color: gray;
    z-index: 1000;
  }
  body {
    padding: 0;
    margin: 0;
    font-size: 112.5%;
    font-family: serif;
  }
  @media print {
    img {page-break-inside: avoid;}
    div.nosplit {page-break-inside: avoid;}
  }
  img {
    width: 100%;
  }
  img.center {
    display: block;
    margin: 0 auto;
  }
  img.resizable {
    max-width: 100%;
    height: auto;
  }
  p code, li code {
    font-size: 14px;
    word-wrap: break-word;
    padding: 2px 4px;
    border-radius: 4px;
    margin: 0 2px;
    color: #1e6bb8;
    background-color: rgba(27,31,35,.05);
    font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;
    word-break: break-all;
  }
  strong {
    font-weight: bold;
    color: darkred;
  }
  .pad {
    padding-top: 1em;
    padding-bottom: 1em;
  }
  a.anchor, a.back, a.footnote {
    color: black !important;
    text-decoration: none !important;
  }
  a.back {
    font-size: 50%;
  }
  @media print {
    a.back {display: none;}
  }
  .header {
    height: 1.25em;
    background-color: #dff;
    margin: 0;
    padding: 0.1em 0.1em 0.2em;
    border-top: 1px solid black;
    border-bottom: 1px solid #8ff;
  }
  .header h3 {
    margin: 0;
    padding: 0 2em;
    display: inline-block;
    padding-right: 2em;
    font-style: italic;
    font-size: 90%;
  }
  .rss {
    float: right;
    padding-top: 0.2em;
    padding-right: 2em;
    display: none;
  }
  .toc {
    margin-top: 2em;
  }
  .toc-title {
    font-family: cursive, serif;
    font-style: italic;
    font-size: 300%;
    line-height: 83%;
  }
  .toc-subtitle {
    display: block;
    margin-bottom: 1em;
    font-size: 83%;
  }
  @media only screen and (max-width: 550px) { .toc-subtitle { display: none; } }
  .header h3 a {
    color: black;
  }
  .header h4 {
    margin: 0;
    padding: 0;
    display: inline-block;
    font-weight: normal;
    font-size: 83%;
  }
  @media only screen and (max-width: 550px) { .header h4 { display: none; } }
  .main {
    padding: 0 2em;
  }
  @media only screen and (max-width: 479px) { .article { font-size: 120%; } }
  .article h1 {
    text-align: center;
    font-size: 200%;
  }
  .copyright {
    font-size: 83%;
  }
  .subtitle {
      font-size: 65%;
  }
  .normal {
    text-align: center;
    font-size: medium;
    font-weight: normal;
  }
  .when {
    text-align: center;
    font-size: 100%;
    margin: 0;
    padding: 0;
  }
  .when p {
    margin: 0;
    padding: 0;
  }
  .article h2 {
    font-size: 125%;
    padding-top: 0.25em;
  }
  .article h3 {
    font-size: 100%;
  }
  .footer {
    margin-top: 10px;
    font-size: 83%;
    font-family: sans-serif;
  }
  .comments {
    margin-top: 2em;
    background-color: #ffe;
    border-top: 1px solid #aa4;
    border-left: 1px solid #aa4;
    border-right: 1px solid #aa4;
  }
  .comments-header {
    padding: 0 5px 0 5px;
  }
  .comments-header p {
    padding: 0;
    margin: 3px 0 0 0;
  }
  .comments-body {
    padding: 5px 5px 5px 5px;
  }
  #plus-comments {
    border-bottom: 1px dotted #ccc;
  }
  .plus-comment {
    width: 100%;
    font-size: 14px;
    border-top: 1px dotted #ccc;
  }
  .me {
    background-color: #eec;
  }
  .plus-comment ul {
    margin: 0;
    padding: 0;
    list-style: none;
    width: 100%;
    display: inline-block;
  }
  .comment-when {
    color:#999;
    width:auto;
    padding:0 5px;
  }
  .old {
    font-size: 83%;
  }
  .plus-comment ul li {
    display: inline-block;
    vertical-align: top;
    margin-top: 5px;
    margin-bottom: 5px;
    padding: 0;
  }
  .plus-icon {
    width: 45px;
  }
  .plus-img {
    float: left;
    margin: 4px 4px 4px 4px;
    width: 32px;
    height: 32px;
  }
  .plus-comment p {
    margin: 0;
    padding: 0;
  }
  .plus-clear {
    clear: left;
  }
  .toc-when {
    font-size: 83%;
    color: #999;
  }
  .toc {
    list-style: none;
  }
  .toc li {
    margin-bottom: 0.5em;
  }
  .toc-head {
    margin-bottom: 1em !important;
    font-size: 117%;
  }
  .toc-summary {
    margin-left: 2em;
  }
  .post-summary {
    text-align: center;
    color: #666;
    font-style: italic;
    margin: 0.5em 0 1.5em;
  }
  .favorite {
    font-weight: bold;
  }
  .article p, .article ol {
    line-height: 144%;
  }
  sup, sub {
    vertical-align: baseline;
    position: relative;
    font-size: 83%;
  }
  sup {
    bottom: 1ex;
  }
  sub {
    top: 0.8ex;
  }

  .main {
    position: relative;
    margin: 0 auto;
    padding: 0;
    width: 900px;
  }
  @media only screen and (min-width: 768px) and (max-width: 959px) { .main { width: 708px; } }
  @media only screen and (min-width: 640px) and (max-width: 767px) { .main { width: 580px; } }
  @media only screen and (min-width: 480px) and (max-width: 639px) { .main { width: 420px; } }
  @media only screen and (max-width: 479px) { .main { width: 90%; } }

  .pager {display: flex;margin-bottom: 20px}
  .pager:last-of-type {margin-top: 50px;}

  .pager span, .pager   a {flex: 50%;line-height:50px;}
  .pager a {color: var(--pager-fg); padding: 0 10px; border-radius: 4px; border: 1px solid #ccc; text-decoration: none; }
  .pager a:hover{background: var(--pager-hover); border-color: #bbb;}
  .pager .prev {margin-right: 10px;}
  .pager a.prev:not(:empty):before{content: '« '}
  .pager a.next:not(:empty):after{content: ' »'}
  .pager .next {text-align: right;margin-left: 10px}

</style>
<link rel="stylesheet" href="/libs/highlight/styles/a11y-dark.min.css">
<script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body>
    
<div class="header">
  <h3><a href="/">lyyyuna 的小花园</a></h3>
  <h4>动静中之动,
    by <a href="https://www.lyyyuna.com/about/" rel="author">lyyyuna</a> </h4>
  <a class="rss" href="https://www.lyyyuna.com/feed.atom">RSS</a>
</div>

<div class="main">
  <div class="article">
    <h1>SCons 用户指南第三章-让 SCons 编译更简单
    
    <div class="subtitle">(<i><a href="/series/SCons 用户指南/">SCons 用户指南</a>, Part 3</i>)</div>
    </h1>
    <div class="normal">
      <div class="when">

          发表于 2015-12

      </div>
    </div>
    
    <p>在本章中，你将看到一些使用 SCons 编译配置的简单例子。这些例子表明，在不同系统和不同语言上使用 SCons 都是非常易用的。</p>
<h2>3.1 指定目标文件的名称</h2>
<p>在前几章的例子中，你已经看到了使用 Program 编译方法生成的目标文件名称和源文件相同。也就是说，如下的命令在 POSIX 系统上将生成可执行文件 hello，而在 Windows 上将生成 hello.exe。</p>
<pre><code>Program('hello.c')
</code></pre>
<p>如果你想要自定义名称，你只需要在调用时在源文件左侧指定就行：</p>
<pre><code>Program('new_hello', 'hello.c')
</code></pre>
<p>（SCons 要求目标文件的名称放在第一个，然后是源文件的名称，因此这个顺序模仿了大部分编程语言中的赋值顺序，包括 Python: &quot;program = source files&quot;）</p>
<p>如下的命令将在 POSIX 系统上生成一个可执行程序 new_hello：</p>
<pre><code>% scons -Q
cc -o hello.o -c hello.c
cc -o new_hello hello.o
</code></pre>
<p>如下的命令将在 Windows 系统上生成可执行程序 new_hello.exe：</p>
<pre><code>C:\&gt;scons -Q
cl /Fohello.obj /c hello.c /nologo
link /nologo /OUT:new_hello.exe hello.obj
embedManifestExeCheck(target, source, env)
</code></pre>
<h2>3.2 编译多个源文件</h2>
<p>你已经看到了如何使用 SCons 从单个源文件编译的例子。在实际开发过程中，更多的是编译多个源文件的例子。为此，你只需要将源文件放在 Python list 中即可，如下所示：</p>
<pre><code>Program(['prog.c', 'file1.c', 'file2.c'])
</code></pre>
<p>编译过程如下：</p>
<pre><code>% scons -Q
cc -o file1.o -c file1.c
cc -o file2.o -c file2.c
cc -o prog.o -c prog.c
cc -o prog prog.o file1.o file2.o
</code></pre>
<p>可以看到，SCons 自动从列表的第一个源文件名推导出可执行程序的名字。由于第一个源文件名为 prog.c，SCons 会将生成文件命名为 prog （或者在 Windows 上是 prog.exe）。如果你想指定不同的名字，你只需要将源文件列表放在第二个参数，在第一个参数放置可执行程序名：</p>
<pre><code>Program('program', ['prog.c', 'file1.c', 'file2.c'])
</code></pre>
<p>在 Linux 上，编译过程如下：</p>
<pre><code>% scons -Q
cc -o file1.o -c file1.c
cc -o file2.o -c file2.c
cc -o prog.o -c prog.c
cc -o program prog.o file1.o file2.o
</code></pre>
<p>在 Windows 上：</p>
<pre><code>C:\&gt;scons -Q
cl /Fofile1.obj /c file1.c /nologo
cl /Fofile2.obj /c file2.c /nologo
cl /Foprog.obj /c prog.c /nologo
link /nologo /OUT:program.exe prog.obj file1.obj file2.obj
embedManifestExeCheck(target, source, env)
</code></pre>
<h2>3.3 用 Glob 函数生成文件列表</h2>
<p>你也可以使用 Glob 函数来匹配出所有符合特定模式的源文件。模式可以是标准 shell 的模式匹配格式，比如 *, ?, [abc], [!abc]。这种方法使得在写多源文件时变得非常容易。</p>
<pre><code>Program('program', Glob('*.c'))
</code></pre>
<h2>3.4 指定单个文件 Vs. 文件列表</h2>
<p>我们已经展示了两种指定程序源文件的方法，第一种是使用文件的列表：</p>
<pre><code>Program('hello', ['file1.c', 'file2.c'])
</code></pre>
<p>第二种是使用单个文件：</p>
<pre><code>Program('hello', 'hello.c')
</code></pre>
<p>你实际上也可以将单个文件名放入一个列表中。这样你的脚本格式能够保持一致：</p>
<pre><code>Program('hello', ['hello.c'])
</code></pre>
<p>SCons 函数能够接受以上任何一种形式。实际上 SCons 将输入都看作是文件列表，但是允许你在输入单个源文件时省略方括号。</p>
<h3>重要</h3>
<p>虽然 SCons 函数不严格区分字符串和列表，但 Python 本身对这两者严格区分。所以在 SCons 允许既可以字符串和列表时：</p>
<pre><code># The following two calls both work correctly:
Program('program1', 'program1.c')
Program('program2', ['program2.c'])
</code></pre>
<p>如果对混有字符串和列表的情况做一些 Python 的操作，可能会导致发生错误和不正确的结果：</p>
<pre><code>common_sources = ['file1.c', 'file2.c']

# THE FOLLOWING IS INCORRECT AND GENERATES A PYTHON ERROR
# BECAUSE IT TRIES TO ADD A STRING TO A LIST:
Program('program1', common_sources + 'program1.c')

# The following works correctly, because it's adding two
# lists together to make another list.
Program('program2', common_sources + ['program2.c'])
</code></pre>
<h2>3.5 让文件列表更容易阅读</h2>
<p>使用 Python 列表的一打缺点就是每个源文件名都必须包含在引号之间。当文件名很长时，就会显得累赘且不易阅读。幸运的是，SCons 和 Python 都提供了多种方式来简化 SConstruct 的阅读。</p>
<p>为了使长文件列表易于处理，SCons 提供了 Split 函数来处理被引号包含且用空格或其他空白字符分隔的文件名，处理之后将转换成文件列表。对前一个例子使用 Split 函数：</p>
<pre><code>Program('program', Split('main.c file1.c file2.c'))
</code></pre>
<p>（你如果熟悉 Python, 你应该已经意识到这和 string 模块中的 split() 函数非常相似。和 split() 成员函数不同的是， Split 函数并不要求输入一定是一个字符串，并将列表中单个字符串包起来。如果对象已经是一个列表，则直接原样返回不变。对于任意值传递到 SCons 函数中，这是一个方便的方法，这有就无需手工检查该变量的类型。）</p>
<p>将 Split 函数放在 Program 调用中仍然显得笨拙。一个易读的方法是将 Split 调用的输出赋值给一个变量，然后将变量传递给 Program 函数：</p>
<pre><code>src_files = Split('main.c file1.c file2.c')
Program('program', src_files)
</code></pre>
<p>最后需说明的是，Split 函数并不关心文件名之间空格的长度，这样你可以创建跨越多行的文件列表字符串，更容易编辑：</p>
<pre><code>src_files = Split(&quot;&quot;&quot;main.c
                     file1.c
                     file2.c&quot;&quot;&quot;)
Program('program', src_files)
</code></pre>
<p>（这个例子中使用了 Python 的三重引号表示法，使得字符串能跨越多行，这里既可以是单引号也可以是双引号。）</p>
<h2>3.6 关键字参数</h2>
<p>SCons 也允许你使用 Python 的关键字参数来指定输出文件和输入源文件。输出文件是 target，输入文件是 source。Python 语法如下：</p>
<pre><code>src_files = Split('main.c file1.c file2.c')
Program(target = 'program', source = src_files)
</code></pre>
<p>由于关键字显示指定了参数，所以实际上如果你喜欢，你可以颠倒它们的顺序：</p>
<pre><code>src_files = Split('main.c file1.c file2.c')
Program(source = src_files, target = 'program')
</code></pre>
<p>至于你是否用关键字参数纯属个人喜好，SCons 函数的执行效果完全相同。</p>
<h2>3.7 编译多个程序</h2>
<p>为了能够在下单个 SConstruct 文件中编译多个程序， 你只需要调用 Program 方法多次即可，每一个输出程序对应一个调用。</p>
<pre><code>Program('foo.c')
Program('bar', ['bar1.c', 'bar2.c'])
</code></pre>
<p>SCons 的编译输出如下：</p>
<pre><code>% scons -Q
cc -o bar1.o -c bar1.c
cc -o bar2.o -c bar2.c
cc -o bar bar1.o bar2.o
cc -o foo.o -c foo.c
cc -o foo foo.o
</code></pre>
<p>注意到 SCons 编译的顺序和 SConstruct 文件中指定的顺序并不相同。实际上 SCons 能够自动识别出单个二进制文件的编译顺序。我们将在下面的“<em>依赖</em>”章节中详细阐述。</p>
<h2>3.8 在多个编译程序中共享源文件</h2>
<p>在多个编译程序中共享源文件是常见的复用代码的方法。其中一个方法就是根据常用的源文件生成库，然后让最终生成程序都链接该库。（创建库将在第 4 章，生成和链接库 中详述。）</p>
<p>更直接，可能稍微麻烦的方法是将共同的源文件都放入各自的源文件列表中：</p>
<pre><code>Program(Split('foo.c common1.c common2.c'))
Program('bar', Split('bar1.c bar2.c common1.c common2.c'))
</code></pre>
<p>即使 common1.c 和 common2.c 生成的二进制文件被链接了两次，SCons 也能够自动识别出它们只需要分别编译一次即可：</p>
<pre><code>% scons -Q
cc -o bar1.o -c bar1.c
cc -o bar2.o -c bar2.c
cc -o common1.o -c common1.c
cc -o common2.o -c common2.c
cc -o bar bar1.o bar2.o common1.o common2.o
cc -o foo.o -c foo.c
cc -o foo foo.o common1.o common2.o
</code></pre>
<p>如果两个或多个程序共享了大量的源文件，那么重复输入源文件名会带来维护上的问题。你可以使用另外一个 Python 列表来存储共同源文件名，然后使用 Python 的 + 运算符进行链接：</p>
<pre><code>common = ['common1.c', 'common2.c']
foo_files = ['foo.c'] + common
bar_files = ['bar1.c', 'bar2.c'] + common
Program('foo', foo_files)
Program('bar', bar_files)
</code></pre>
<p>这和上一个例子功能完全相同。</p>

  </div>

    
    <div class="pager">

      
        <a class="prev" href="/2015/11/02/scons2-simple-build/">
          SCons 用户指南第二章-简单编译
        </a>
      

      
        <a class="next" href="/2015/12/25/scons4-building-and-linking-with-libraries/">
          SCons 用户指南第四章 - 编译和链接库
        </a>
      

    </div>
    
  <div class="icp"> lyyyuna <a href="https://beian.miit.gov.cn/" target="_blank" rel="nofollow">沪ICP备2025110782号-1</a></div>
</div>



<div id="stats" class="icp"></div> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-1G7RNXMWQX"></script> <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1G7RNXMWQX');
</script> <script async src="https://analytics.lyyyuna.com/v1/stats.js"></script>


</body>
</html>
