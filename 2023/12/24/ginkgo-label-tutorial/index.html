
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>lyyyuna 的小花园: Ginkgo Label 标签的使用教程</title>
    
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  table {
      border-collapse: collapse;
      width: 100%;
  }
  th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
  }
  th {
      background-color: #f2f2f2;
  }
  
  .icp {
    margin: 10px 0;
    width: 100%;
    height: 36px;
    white-space: pre;
    text-align: center;
    color: gray;
    z-index: 1000;
  }
  body {
    padding: 0;
    margin: 0;
    font-size: 112.5%;
    font-family: serif;
  }
  @media print {
    img {page-break-inside: avoid;}
    div.nosplit {page-break-inside: avoid;}
  }
  img {
    width: 100%;
  }
  img.center {
    display: block;
    margin: 0 auto;
  }
  img.resizable {
    max-width: 100%;
    height: auto;
  }
  p code, li code {
    font-size: 14px;
    word-wrap: break-word;
    padding: 2px 4px;
    border-radius: 4px;
    margin: 0 2px;
    color: #1e6bb8;
    background-color: rgba(27,31,35,.05);
    font-family: Operator Mono, Consolas, Monaco, Menlo, monospace;
    word-break: break-all;
  }
  strong {
    font-weight: bold;
    color: darkred;
  }
  .pad {
    padding-top: 1em;
    padding-bottom: 1em;
  }
  a.anchor, a.back, a.footnote {
    color: black !important;
    text-decoration: none !important;
  }
  a.back {
    font-size: 50%;
  }
  @media print {
    a.back {display: none;}
  }
  .header {
    height: 1.25em;
    background-color: #dff;
    margin: 0;
    padding: 0.1em 0.1em 0.2em;
    border-top: 1px solid black;
    border-bottom: 1px solid #8ff;
  }
  .header h3 {
    margin: 0;
    padding: 0 2em;
    display: inline-block;
    padding-right: 2em;
    font-style: italic;
    font-size: 90%;
  }
  .rss {
    float: right;
    padding-top: 0.2em;
    padding-right: 2em;
    display: none;
  }
  .toc {
    margin-top: 2em;
  }
  .toc-title {
    font-family: cursive, serif;
    font-style: italic;
    font-size: 300%;
    line-height: 83%;
  }
  .toc-subtitle {
    display: block;
    margin-bottom: 1em;
    font-size: 83%;
  }
  @media only screen and (max-width: 550px) { .toc-subtitle { display: none; } }
  .header h3 a {
    color: black;
  }
  .header h4 {
    margin: 0;
    padding: 0;
    display: inline-block;
    font-weight: normal;
    font-size: 83%;
  }
  @media only screen and (max-width: 550px) { .header h4 { display: none; } }
  .main {
    padding: 0 2em;
  }
  @media only screen and (max-width: 479px) { .article { font-size: 120%; } }
  .article h1 {
    text-align: center;
    font-size: 200%;
  }
  .copyright {
    font-size: 83%;
  }
  .subtitle {
      font-size: 65%;
  }
  .normal {
    text-align: center;
    font-size: medium;
    font-weight: normal;
  }
  .when {
    text-align: center;
    font-size: 100%;
    margin: 0;
    padding: 0;
  }
  .when p {
    margin: 0;
    padding: 0;
  }
  .article h2 {
    font-size: 125%;
    padding-top: 0.25em;
  }
  .article h3 {
    font-size: 100%;
  }
  .footer {
    margin-top: 10px;
    font-size: 83%;
    font-family: sans-serif;
  }
  .comments {
    margin-top: 2em;
    background-color: #ffe;
    border-top: 1px solid #aa4;
    border-left: 1px solid #aa4;
    border-right: 1px solid #aa4;
  }
  .comments-header {
    padding: 0 5px 0 5px;
  }
  .comments-header p {
    padding: 0;
    margin: 3px 0 0 0;
  }
  .comments-body {
    padding: 5px 5px 5px 5px;
  }
  #plus-comments {
    border-bottom: 1px dotted #ccc;
  }
  .plus-comment {
    width: 100%;
    font-size: 14px;
    border-top: 1px dotted #ccc;
  }
  .me {
    background-color: #eec;
  }
  .plus-comment ul {
    margin: 0;
    padding: 0;
    list-style: none;
    width: 100%;
    display: inline-block;
  }
  .comment-when {
    color:#999;
    width:auto;
    padding:0 5px;
  }
  .old {
    font-size: 83%;
  }
  .plus-comment ul li {
    display: inline-block;
    vertical-align: top;
    margin-top: 5px;
    margin-bottom: 5px;
    padding: 0;
  }
  .plus-icon {
    width: 45px;
  }
  .plus-img {
    float: left;
    margin: 4px 4px 4px 4px;
    width: 32px;
    height: 32px;
  }
  .plus-comment p {
    margin: 0;
    padding: 0;
  }
  .plus-clear {
    clear: left;
  }
  .toc-when {
    font-size: 83%;
    color: #999;
  }
  .toc {
    list-style: none;
  }
  .toc li {
    margin-bottom: 0.5em;
  }
  .toc-head {
    margin-bottom: 1em !important;
    font-size: 117%;
  }
  .toc-summary {
    margin-left: 2em;
  }
  .favorite {
    font-weight: bold;
  }
  .article p, .article ol {
    line-height: 144%;
  }
  sup, sub {
    vertical-align: baseline;
    position: relative;
    font-size: 83%;
  }
  sup {
    bottom: 1ex;
  }
  sub {
    top: 0.8ex;
  }

  .main {
    position: relative;
    margin: 0 auto;
    padding: 0;
    width: 900px;
  }
  @media only screen and (min-width: 768px) and (max-width: 959px) { .main { width: 708px; } }
  @media only screen and (min-width: 640px) and (max-width: 767px) { .main { width: 580px; } }
  @media only screen and (min-width: 480px) and (max-width: 639px) { .main { width: 420px; } }
  @media only screen and (max-width: 479px) { .main { width: 90%; } }

  .pager {display: flex;margin-bottom: 20px}
  .pager:last-of-type {margin-top: 50px;}

  .pager span, .pager   a {flex: 50%;line-height:50px;}
  .pager a {color: var(--pager-fg); padding: 0 10px; border-radius: 4px; border: 1px solid #ccc; text-decoration: none; }
  .pager a:hover{background: var(--pager-hover); border-color: #bbb;}
  .pager .prev {margin-right: 10px;}
  .pager a.prev:not(:empty):before{content: '« '}
  .pager a.next:not(:empty):after{content: ' »'}
  .pager .next {text-align: right;margin-left: 10px}

</style>
<link rel="stylesheet" href="/libs/highlight/styles/a11y-dark.min.css">
<script src="/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body>
    
<div class="header">
  <h3><a href="/">lyyyuna 的小花园</a></h3>
  <h4>动静中之动,
    by <a href="https://www.lyyyuna.com/about/" rel="author">lyyyuna</a> </h4>
  <a class="rss" href="https://www.lyyyuna.com/feed.atom">RSS</a>
</div>

<div class="main">
  <div class="article">
    <h1>Ginkgo Label 标签的使用教程
    
    <div class="subtitle">(<i><a href="/series/Ginkgo 使用笔记/">Ginkgo 使用笔记</a>, Part 3</i>)</div>
    </h1>
    <div class="normal">
      <div class="when">
        
          发表于 2023-12
          
      </div>
    </div>
    <h2>前言</h2>
<p>很多测试框架都提供了对测试用例分组的能力，比如 <code>pytest</code> 中的 <code>mark</code>，<code>Robot Framework</code> 中的 <code>tag</code>，<code>TestNG</code> 中的 <code>groups</code> 等等。</p>
<p>在 <code>Ginkgo v1</code> 中，并没有类似的功能，在七牛，我们不得不将<strong>标签</strong>嵌入在字符串标题中，配合 <code>--focus</code> 来过滤用例。但基于字符串的实现并不完美，很容易出现冲突、重复，更不能提供类型安全，导致在海量集测用例面前，<code>Ginkgo v1</code> 用起来总感觉力不从心。</p>
<p>到了 <code>Ginkgo v2</code>，官方终于给出了 <code>Label</code> 这个解决方案，下面，我们来看看它都有哪些使用方法。</p>
<p>P.S. 本文基于 <code>Ginkgo v2.13.2</code>。</p>
<h2>基础使用方法</h2>
<h3>给用例添加标签</h3>
<p>标签用 <code>Label</code> 装饰器定义，并且可以定义在任意一种节点之上，例如：</p>
<pre><code class="language-go">Describe(&quot;上传&quot;, Label(&quot;integration&quot;, &quot;storage&quot;), func() {
    It(&quot;表单上传&quot;, Label(&quot;network&quot;, &quot;slow&quot;, &quot;library storage&quot;), func() {
        // 最终获得的标签 [integration, storage, network, slow, library storage]
    })

    Context(&quot;分片上传&quot;, Label(&quot;network&quot;, &quot;library storage&quot;), func() {
        It(&quot;1 个分片&quot;, Label(&quot;slow&quot;) func() {
            // 最终获得的标签 [integration, storage, network, slow, library storage]
        })

        It(&quot;2 个分片&quot;, Label(&quot;quick&quot;, &quot;storage&quot;) func() {
            // 最终获得的标签 [integration, storage, network, quick, library storage]
        })
    })

    DescribeTable(&quot;s3 协议&quot;, Label(&quot;quick&quot;), func(count int) {
        
    },
        Entry(&quot;put 上传&quot;, Label(&quot;local&quot;), 17), // 最终获得的标签 [integration, storage, quick, local]
        Entry(&quot;拷贝上传&quot;, 20), // 最终获得的标签 [integration, storage, quick]
    )
})
</code></pre>
<p>总结一下：</p>
<ol>
<li>标签本质是一个字符串。</li>
<li>子节点会继承父节点定义的标签，即 <code>It</code> 会继承 <code>Context</code> 和 <code>Describe</code> 上的标签。</li>
<li>标签会自动去重，子节点不用担心标签重复。</li>
<li><code>Entry</code> 上也可以定义标签，不会被当作参数。</li>
</ol>
<h3>过滤</h3>
<p><code>Ginkgo</code> 已经有很多过滤用例的方法：首先是 <code>--focus-file</code> 和 <code>--skip-file</code>，可以根据文件名和行号来过滤用例；然后是 <code>--focus</code> 和 <code>--skip</code>，可以根据用例的标题来过滤用例。这两个都支持正则表达式。但用例分类并不一定会集中于特定的目录中，比如为测试环境和线上环境各自编写的用例，这些用例会分散在各个目录、各个文件、各种用例中。而且，正则表达式并不直观，如果基于标题写正则表达式，恐怕这个命令行会非常<strong>糟糕</strong>。</p>
<p>而标签真正的威力，就在于其更易用的过滤语法。</p>
<p><code>Ginkgo</code> 使用 <code>--label-filter=QUERY</code> 可以传入基于标签的查询语句，其规则规则一目了然：</p>
<ul>
<li><code>标签1 &amp;&amp; 标签2</code> ，用例同时含有两个标签，即符合条件。</li>
<li><code>标签1 || 标签2</code>，用例只需拥有一个标签，即符合条件。</li>
<li><code>!标签1</code>，有标签1的用例不符合条件。</li>
<li><code>,</code> 的逻辑和 <code>||</code> 相同。</li>
<li><code>()</code> 可以用来组合表达式。例如 <code>标签1 &amp;&amp; (标签2 || 标签3)</code></li>
<li>标签是大小写敏感的。</li>
<li>标签前后的空白会自动去除。</li>
</ul>
<p>举例来说，我们正在测试一个云存储产品，我们有以下 4 个测试用例，分别是：</p>
<ol>
<li>用例1: product, local, cn-east-1, slow</li>
<li>用例2: local, cn-east-1, ap-southeast-1</li>
<li>用例3: local, ap-southeast-1</li>
<li>用例4: product, slow</li>
</ol>
<p>其中</p>
<ol>
<li>product 代表用例能在线上跑，local 代表用例能在测试环境跑。</li>
<li>cn-east-1 代表用例能在华东区域跑，ap-southeast-1 代表用例能在东南亚区域跑。</li>
<li>slow 代表用例运行时间较长。</li>
</ol>
<p>如果使用以下过滤语句：</p>
<ol>
<li><code>product</code>，即挑选所有能在线上跑的用例，那用例1和用例4会执行。</li>
<li><code>!local</code>，即挑选所有不能在测试环境跑的用例，那只有用例4会执行。</li>
<li><code>product &amp;&amp; cn-east-1</code>，即挑选线上华东区域的所有用例，那只有用例1会执行。</li>
<li><code>cn-east-1 || ap-south-east-1</code>，即挑选能同时在华东和东南亚区域运行的用例，那用例1、2、3会执行。</li>
<li><code>!slow</code>，即排除时间过长的用例，那用例2、3会执行。</li>
</ol>
<p>可以发现，新的过滤语法更为直观，使用者能快速组合出想要的用例。（如果上述过滤语法仍不满足要求，可以用 <code>/REGEXP/</code> 来使用正则表达式）</p>
<h3>组合使用</h3>
<p><code>Ginkgo v2</code> 并没有删去 <code>Ginkgo v1</code> 已有的过滤功能，而是可以组合使用：</p>
<ol>
<li>如果用例被标记为 <code>Pending</code>，那无论如何都不会运行。</li>
<li>如果用例中调用了 <code>Skip()</code> 函数，即使命中了过滤语句，仍然会被忽略。</li>
<li>如果用例被标记为 <code>Focus</code>，那只会运行该用例。</li>
<li>如果命令行同时有 <code>--label-filter</code>, <code>--focus-file/--skip-file</code>, <code>--focus/--skip</code>，那最终用例必须同时符合这些条件。</li>
</ol>
<h3>测试报告</h3>
<p>标签在官方自带的 <code>JUnit Report</code> 报告中，不是一个单独的属性，而是附在标题中：</p>
<pre><code>Kodo e2e Suite.[It] 测试 s3 分片上传 [module=bucket, KODO-18044, unstable, id=c522c, id=be25c]
</code></pre>
<p>后面 <code>[xxx, yyy, zzz]</code> 便是该用例所有的标签。</p>
<h2>高级使用</h2>
<h3>组合标签</h3>
<p><code>Ginkgo</code> 提供了 <code>Label()</code> 函数来定义标签类型 <code>Labels</code>，它们的关系如下：</p>
<pre><code class="language-go">func Label(labels ...string) Labels {
	return Labels(labels)
}

type Labels = internal.Labels
</code></pre>
<p>默认的 <code>Label()</code> 函数在面对多标签时并不灵活，举个例子，假设我们测试云存储产品，它有 4 个存储区域：</p>
<ol>
<li><code>cn-east-1</code> 华东</li>
<li><code>cn-north-1</code> 华北</li>
<li><code>cn-northwest-1</code> 西北</li>
<li><code>ap-southeast-2</code> 东南亚</li>
</ol>
<p>我们可能会定义以下四个标签来标注用例是否可以在对应区域运行：</p>
<pre><code class="language-go">var ZCnEast1 = Label(&quot;cn-east-1&quot;)

var ZCnNorth1 = Label(&quot;cn-north-1&quot;)

var ZCnNorthWest1 = Label(&quot;cn-northwest-1&quot;)

var ZApSouthEast2 = Label(&quot;ap-southeast-2&quot;)
</code></pre>
<p>但若每个用例都要标注4个标签，写起来比较繁琐，你可能会定义一个全区域标签来表示该用例可以在任意区域运行：</p>
<pre><code class="language-go">var ZAll = Label(&quot;cn-east-1&quot;, &quot;cn-north-1&quot;, &quot;cn-northwest-1&quot;, &quot;ap-southeast-2&quot;)
</code></pre>
<p>直接使用字符串会有类型安全问题，所以可以定义一个辅助函数来组合已有标签。</p>
<p>因为标签本质是 <code>Labels</code> 类型，只要定义一个 <code>combine([]Labels) Labels</code> 的函数即可：</p>
<pre><code class="language-go">func combine(labels ...Labels) Labels {
	mapl := make(map[string]bool)

	for _, ls := range labels {
		for _, l := range ls {
			mapl[l] = true
		}
	}

	out := make([]string, 0)
	for k := range mapl {
		out = append(out, k)
	}

	return Label(out...)
}

// 全球运行
var ZAll = combine(ZCnEast1, ZCnNorth1, ZCnNorthWest1, ZApSouthEast2)
</code></pre>
<p>同理，如果一个用例只是在 <code>ap-southeast-2</code> 东南亚无法运行，可以定义一个 <code>remove(Labels, ...Labels) Labels</code> 的函数：</p>
<pre><code class="language-go">func remove(all Labels, remove ...Labels) Labels {
	labelNeedsDel := make(map[string]bool)

	for _, labels2 := range remove {
		for _, l := range labels2 {
			labelNeedsDel[l] = true
		}
	}

	out := make([]string, 0)
	for _, l := range all {
		if _, ok := labelNeedsDel[l]; !ok {
			out = append(out, l)
		}
	}

	return Label(out...)
}

// 只能在国内运行
var ZChina = remove(ZAll, ZApSouthEast2)
</code></pre>
<h3>自动过滤</h3>
<h4>根据配置文件过滤</h4>
<p>配置文件天然含有过滤信息，例如线上环境配置、灰度环境配置、本地环境配置。那 <code>Ginkgo</code> 能不能自动添加过滤语句呢？当然可以。</p>
<p>回到 <code>Ginkgo</code> 的启动函数：</p>
<pre><code class="language-go">func TestE2E(t *testing.T) {
	RegisterFailHandler(Fail)

	RunSpecs(t, &quot;e2e Suite&quot;)
}
</code></pre>
<p><code>RunSpecs</code> 可以接受额外的参数：<code>SuiteConfig</code> 和 <code>ReporterConfig</code>，其中 <code>SuiteConfig</code> 可以定制 <code>Ginkgo CLI</code> 启动参数：</p>
<pre><code class="language-go">var EnvProduct = Label(&quot;product&quot;)

suiteConfig, reportConfig := GinkgoConfiguration()
// 与已有的逻辑是与的关系
suiteConfig.LabelFilter = fmt.Sprintf(&quot;(%v) &amp;&amp; (%v)&quot;, suiteConfig.LabelFilter, &quot;product&quot;)

RunSpecs(t, &quot;e2e Suite&quot;, suiteConfig, reportConfig)
</code></pre>
<p>这样，<code>product</code> 标签就被添加到了 <code>--label-filter</code> 中，和已有的过滤逻辑是<strong>与</strong>的关系。</p>
<h4>手动用例</h4>
<p>有可能存在这样一些用例，它们不能完全自动化，验收的时候需要手动执行，人工验证。这些用例在 <code>Ginkgo v1</code> 中，只能被标注为 <code>Skip</code>，每次执行的时候需要将 <code>Skip</code> 装饰器去掉再运行，十分麻烦。</p>
<p>而借助灵活的标签过滤语法，就能在不修改集测代码的情况下运行它，例如：</p>
<pre><code class="language-go">var Manual = Label(&quot;manual&quot;)

// 如果已经有 manual 就不再加 !manual 标签
if !strings.Contains(suiteConfig.LabelFilter, &quot;manual&quot;) {
    suiteConfig.LabelFilter += &quot; &amp;&amp; (!manual)&quot; // 强制排除 manual 标签
}
</code></pre>
<ol>
<li>平时执行集测回归时，会自动添加 <code>!manual</code>，忽略所有的手动用例。</li>
<li>而一旦命令行添加 <code>manual</code> 后，便会过滤出对应的手动用例。</li>
</ol>

  </div>

    
    <div class="pager">

      
        <a class="prev" href="/2023/10/29/one-example-of-ginkgo-e2e-test-enhancement/">
          随机数生成策略对集测性能的影响
        </a>
      

      
        <a class="next" href="/2023/12/29/ginkgo-concurrency-test/">
          Ginkgo 并发测试教程
        </a>
      

    </div>
    
  <div class="icp"> lyyyuna <a href="https://beian.miit.gov.cn/" target="_blank" rel="nofollow">沪ICP备2025110782号-1</a></div>
</div>



<div id="stats" class="icp"></div> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-1G7RNXMWQX"></script> <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1G7RNXMWQX');
</script> <script async src="https://analytics.lyyyuna.com/v1/stats.js"></script>


</body>
</html>
